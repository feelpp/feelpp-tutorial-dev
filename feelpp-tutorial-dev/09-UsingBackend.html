<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using a backend :: Feel++ Programming Tutorial</title>
    <link rel="canonical" href="https://feelpp.github.io/feelpp-tutorial-dev/feelpp-tutorial-dev/09-UsingBackend.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>

<script src="../_/js/vendor/tabs-block-extension.js"></script>
<script src="../_/js/vendor/tabs-block-behavior.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      RR: "{\\mathbb R}",
      NN: "{\\mathbb N}",
      Nso: "{N_{\\mathrm{so}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      Nno: "{N_{\\mathrm{no}}}",
      Ne: "{N_{\\mathrm{e}}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      calTh: "{\\mathcal{T}_h}",
      Ck: ["{\\mathcal{C}^{#1}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Qch: ["{Q^{#1}_{c,h}}",1],
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      poly: ["{\\mathbb{#1}}",1],
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      geo: "{\\mathrm{geo}}",
      card: ["{\\operatorname{card}(#1)}",1],
      dim: ["{\\operatorname{dim}(#1)}",1],
      opdim: "{\\operatorname{dim}}",
      card: ["{\\operatorname{card}(#1)}",1],
      poly: ["{\\mathbb{#1}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      set: ["{\\left\\{#1\\right\\}}",1],
      diam: "{\\operatorname{diam}}",
      jump: ["{[\\![ #1 ]\\!]}",1],
      Next: "{\\mathrm{n}}",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      tr: "{\\operatorname{tr}}",
      Id: "{\\mathcal{I}}",
      disp: ["{\\mathbf{#1}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      domain: "{\\Omega}",
      prect: ["{\\left\\(#1\\right\\)}",1],
      ds: "",
      bold: ["{\\bf #1}",1],
      p: "{\\mathrm{p}}",
      q:"{\\mathbf{q}}",
      n:"{\\mathbf{n}}",
      T:"{\\mathcal{T}}",
      F:"{\\mathcal{F}}",
      P:"{\\mathcal{P}}",
      v:"{\\mathbf{v}}"
  },
  extensions: ["mhchem.js"] }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML'>
</script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->
<script>var uiRootPath = '../_'</script>

  </head>
  <body class="article">
<header class="header">
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark navbar-template-project" style="border-top: 4px solid #9E9E9E">
        <div class="navbar-brand">
            <div class="navbar-item feelpp-logo">
                <a href="https://feelpp.github.io/feelpp-tutorial-dev">Feel++ Programming Tutorial</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <a href="https://docs.feelpp.org/">Documentation Reference</a>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand"  href="https://www.cemosis.fr">
                        <img class="cemosis-logo"  src="../_/img/cemosis-logo.svg" alt="Cemosis logo"/>
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="body">
<div class="nav-container" data-component="feelpp-tutorial-dev" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Feel++ Programming Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Programming environment</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cmake.html">cmake environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="antora.html">antora environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="vscode.html">vscode integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="githubactions.html">Github Actions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rename.html">Renaming the project</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="jupyter.html">Jupyter Notebook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Programming Feel++</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-OutputDirectories.html">File Organisation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-SettingUpEnvironment.html">Runtime Environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-LoadingMesh.html">Loading a Mesh</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-UsingExpressions.html">Using expressions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-EvaluatingFunctions.html">Evaluating a function</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-VisualizingFunctions.html">Visualizing functions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-SpaceElements.html">Using function spaces</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-ComputingIntegrals.html">Computing integrals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-SolveAnEquation.html">Solving a PDE</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="09-UsingBackend.html">Using a solver backend</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="12-CreateModels.html">Creating models</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Feel++ Programming Tutorial</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../dev/latest/index.html">Developer manual</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../dev/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">Feel++ Programming Tutorial</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
    <a href="index.html" class="home-link"></a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Feel++ Programming Tutorial</a></li>
    <li>Programming Feel++</li>
    <li><a href="09-UsingBackend.html">Using a solver backend</a></li>
  </ul>
</nav>

  
    <div class="edit-this-page"><a href="https://github.com/feelpp/feelpp-tutorial-dev/edit/6-update-repo-with-new-feelpp-project/docs/modules/ROOT/pages/09-UsingBackend.adoc">Edit this Page</a></div>
  
  <div class="page-downloads">
  <span class="label">Download as</span>
  <ul class="download-options">
    <li>
      <a onclick="print(this)" href="#" data-toggle="tooltip" data-placement="left" title="Print to PDF"
         class="pdf-download">
        <img class="pdf-file-icon icon" src="../_/img/pdf.svg"/> .pdf
      </a>
    </li>
  </ul>
</div>
</div>

  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>

<article class="doc">
<h1 class="page">Using a backend</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After the discretization process, one may have to solve a (non) linear
system. Feel++ interfaces with PETSc/SLEPc and Eigen3. Consider this
system</p>
</div>
<div class="stemblock">
<div class="content">
\[A x = b\]
</div>
</div>
<div class="paragraph">
<p>We call <code>Backend</code> an object that manages the solution strategy to solve it.
Some explanation are available at <a href="../dev/latest/reference/Solver/solving.html" class="xref page">Solver</a> and
<a href="../dev/latest/reference/Solver/preconditioner.html" class="xref page">Preconditioner</a>.</p>
</div>
<div class="paragraph">
<p>Feel++ provides a default backend that is mostly hidden to the final user.
In many examples, you do not have to take care of the backend.
You change the backend behavior via the command line or config files.</p>
</div>
<div class="paragraph">
<p>For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">./feelpp_doc_mybackend --backend.pc-type=id</code></pre>
</div>
</div>
<div class="paragraph">
<p>will use the identity matrix as a right preconditionner for the
default backend. The size of the preconditionner will be defined from
the size of the A matrix.</p>
</div>
<div class="paragraph">
<p>If you try to solve a different system in size \(A_1 y= c\) with
the same backend or the default without rebuilding it, it will fail.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">backend(_rebuild=true)-&gt;solve(_matrix=A1,_rhs=c,_sol=y);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of that options can be retrieved via the <code>--help-lib</code> argument in the command line.</p>
</div>
<div class="sect2">
<h3 id="_non_default_backend"><a class="anchor" href="#_non_default_backend"></a>1.1. Non default Backend</h3>
<div class="paragraph">
<p>You may need to manage more than one backend in an application: you
have different systems to solve and you want to keep some already
computed objects such as preconditioners.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The default backend is in fact an unnamed backend: in order to
distinguish between backend you have to name them. For example</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">	po::options_description app_options( "MyBackend options" );
	app_options.add(backend_options("myBackend"));

	Environment env(_argc=argc, _argv=argv,
	                _desc = app_options,
	                _about=about(_name="mybackend",
	                             _author="Feel++ Consortium",
	                             _email="feelpp-devel@feelpp.org"));</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>After that, you create the backend object:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">	// create a backend
	auto myBackend = backend(_name="myBackend");</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
the backend&#8217;s name has to match the name you gave at the
options step.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Then, you load meshes, creates spaces etc. At solve time, or you
solve with the default backend:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">	// solve a(u,v)=l(v)
	Feel::cout &lt;&lt; "With default backend\n";
	a.solve(_rhs=l,_solution=u1); // Compute with default backend</code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the important backend option is to be able to monitor the
residuals and iteration count</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./feelpp_tut_mybackend --pc-type=id --ksp-monitor=true --myBackend.ksp-monitor=true</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally you can create a named backend:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">	// solve a(u,v)=l(v)
	Feel::cout &lt;&lt; "With named backend\n";
	a.solveb(_rhs=l,_solution=u2, _backend=myBackend); // Compute with myBackend</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation"><a class="anchor" href="#_implementation"></a>2. Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The implementation reads as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">#include &lt;feel/feelcore/environment.hpp&gt;
#include &lt;feel/feeldiscr/pch.hpp&gt;
#include &lt;feel/feelfilters/unitsquare.hpp&gt;
#include &lt;feel/feelfilters/exporter.hpp&gt;
#include &lt;feel/feelvf/vf.hpp&gt;

using namespace Feel;

int main(int argc, char**argv )
{
	po::options_description app_options( "MyBackend options" );
	app_options.add(backend_options("myBackend"));

	Environment env(_argc=argc, _argv=argv,
	                _desc = app_options,
	                _about=about(_name="mybackend",
	                             _author="Feel++ Consortium",
	                             _email="feelpp-devel@feelpp.org"));

	// create a backend
	auto myBackend = backend(_name="myBackend");

	// create the mesh
	auto mesh = unitSquare();

	// function space
	auto Vh = Pch&lt;2&gt;( mesh );

	// element in Vh
	auto u  = Vh-&gt;element();
	auto u1 = Vh-&gt;element();
	auto u2 = Vh-&gt;element();

	// left hand side
	auto a = form2( _trial=Vh, _test=Vh );
	a = integrate(_range=elements(mesh),
	              _expr=expr(soption("functions.alpha"))*trace(gradt(u)*trans(grad(u))) );

	// right hand side
	auto l = form1( _test=Vh );
	l = integrate(_range=elements(mesh),
	              _expr=expr(soption("functions.f"))*id(u));

	// BC
	a+=on(_range=boundaryfaces(mesh), _rhs=l, _element=u,
	      _expr=expr(soption("functions.g")));

	// solve a(u,v)=l(v)
	Feel::cout &lt;&lt; "With default backend\n";
	a.solve(_rhs=l,_solution=u1); // Compute with default backend
	// solve a(u,v)=l(v)
	Feel::cout &lt;&lt; "With named backend\n";
	a.solveb(_rhs=l,_solution=u2, _backend=myBackend); // Compute with myBackend

	// save results
	auto e = exporter( _mesh=mesh );
	e-&gt;step(0) -&gt; add( "u", u1 );
	e-&gt;step(1) -&gt; add( "u", u2 );
	e-&gt;save();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the associated config file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cfg hljs" data-lang="cfg">ksp-monitor=true
ksp-rtol=1e-5
backend.verbose=true
pc-type=id

[functions]
alpha=1
f=x+y:x:y
g=sin(x):x

[myBackend]
backend.verbose=true
ksp-monitor=true
ksp-rtol=1e-5
pc-type=lu</code></pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer" style="border-top: 2px solid #e9e9e9; background-color: #fafafa; padding-bottom: 2em; padding-top: 2em;">
    <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 0.5em;">
        <div>
            <a href="https://www.cemosis.fr">
                <img src="../_/img/cemosis-logo.svg" alt="Cemosis logo" height="50">
            </a>
        </div>
        <span style="font-size: 0.8rem; color: #9e9e9e">© 2023 <a href="https://www.cemosis.fr" style="text-decoration: underline;">Cemosis</a>, Université de Strasbourg</span>
    </div>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>


<script async src="../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../_/js/vendor/fontawesome.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>


<script type="text/javascript">
function toggleFullScreen() {
   var doc = window.document;
   var docEl = doc.documentElement;

   var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
   var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

   if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
       requestFullScreen.call(docEl);
   }
   else {
       cancelFullScreen.call(doc);
   }
}
</script>
  </body>
</html>
